[{"title":"redis 高可用（HA）集群方案","url":"http://yoursite.com/2017/04/24/redis_ha/","content":"<p>#######<br>redis的高可用方案，3.0之前使用哨兵模式，但当主机挂机，进行主从切换时，会有1到2秒数据的丢失。</p>\n<p>解决方法：当抛出cluster is down时，在 catch中（若要延迟则设置睡眠时间）再执行一次try中的操作，这可让从机成功接替主机后再进行这1到2秒内进行的数据处理，达到数据不丢失。</p>\n<p>这并不是最优的方法。然而，3.0后的集群。可解决上面数据丢失问题</p>\n<p>下面先进行集群的搭建。</p>\n<p>集群搭建方案：</p>\n<p>在3台centos虚拟机上分别安装一主一从的redis，并实现集群功能（集群至少3个主节点，3个从节点）。</p>\n<p>安装redis过程：</p>\n<p>下载redis.</p>\n<p>解压到/usr/local  :   tar -zxvf redis-3.2.8 -C /usr/local</p>\n<p>进行解压后redis目录redis-3.2.8 编译：make </p>\n<p>进入redis-3.2.8/src安装：make install</p>\n<p>(centos系统编译需要安装 gcc tcl)</p>\n<p>建立cluster文件夹：mkdir -p /usr/local/redis-cluster</p>\n<p>在cluster中建立2个目录 8001(备注：放置主机)  8002(备注：放置从机)</p>\n<p>将redis-conf分别copy到这两个文件中，并进行修改 需要修改如下：</p>\n<p>1，修改 绑定本机IP</p>\n<p>bind 192.168.48.130</p>\n<p>2 修改 端口号</p>\n<p>port 8001</p>\n<p>3 修改 指定数据存放目录</p>\n<p>dir /usr/local/redis-cluster/8001/</p>\n<p>4 修改 开启 aof</p>\n<p>appendonly yes</p>\n<p>5 修改 开启集群</p>\n<p> cluster-enabled yes</p>\n<p>6 修改 节点配置名称</p>\n<p> cluster-config-file nodes-8001.conf</p>\n<p>7 修改 timeout</p>\n<p> cluster-node-timeout 15000</p>\n<p>#####安装启动集群脚本<br><code>yum install ruby</code></p>\n<p><code>yum install rubygems</code></p>\n<p><code>gem install redis</code></p>\n<p>将以上安装操作重复，安装在三台不同的虚拟机上。</p>\n<p>#####最后启动集群操作（在其中一台虚拟机上启动即可）：</p>\n<pre><code>`cd /usr/local/redis-3.2.8/src`\n\n`./redis-trib.rb create --replicas 1 192.168.48.133:8001 192.168.48.132:8001 192.168.48.130:8001 192.168.48.133:8002 192.168.48.132:8002 192.168.48.130:8002`\n</code></pre><p><img src=\"https://static.oschina.net/uploads/space/2017/0423/234336_c1D0_1448523.png\" alt=\"\"></p>\n<p>#####说明：<br>–replicas后面的 1 ，这个数字指主从比例 ，3主3从所以为1，后面跟着的host，按顺序  前三台为主，后三台为从，第一台主对应第四台从。</p>\n<p>#####简单测试：<br><img src=\"https://static.oschina.net/uploads/space/2017/0424/000140_PhFW_1448523.png\" alt=\"\"></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0424/000158_UEWl_1448523.png\" alt=\"\"></p>\n<p>######哨兵模式的主从数据是一样的，而集群模式数据是分布在不同机器不同的slot上。</p>\n"},{"title":"redis 条件查询","url":"http://yoursite.com/2017/04/17/redis_select/","content":"<p>####### 问题<br>假设有一user表存放在redis中，现要对这张user表进行条件查询，该怎么做？</p>\n<p>由于redis这类非关系型数据库是无法进行 select * from x where …..等操作的。</p>\n<p>那么该怎么实现这种查询需求呢？</p>\n<p>######## 方法一<br>在redis中取出所有user进行遍历，将符合条件的进行筛选，最后得到结果。</p>\n<p>但感觉这种处理方法过于烦琐，数据量过大时性能可能会有影响，所以这并不是最优的方法。</p>\n<p>######## 方法二<br>在将user表中的数据存储到redis时，进行业务数据划分。</p>\n<p>假如要将性别进行划分，方便查询不同性别用户。例如用户为男的key为：<strong>USER_GENDER_M</strong>，女key的为：<strong>USER_GENDER_F</strong>。在将user数据存储到redis时，同时增加以下一步操作将男与女的userId分别add到不同的key中。</p>\n<p>若user是男的则</p>\n<pre><code>`Jedis.sadd(USER_GENDER_M,userId)`\n</code></pre><p>是女的则进行：</p>\n<p><code>Jedis.sadd(USER_GENDER_F,userId)</code></p>\n<p>通过以下查询就可以得到所有男性用户的userId：</p>\n<p><code>Jedis.smembers(USER_GENDER_M)</code></p>\n<p>最后通过以下查询就可以得到所有男性用户数据：</p>\n<pre><code>`Jedis.hmget(USER,user1Id,user2Id...)`\n</code></pre><p>若是有其它条件，也如此设计查询业务，例如某年龄阶段的，某区域的等等的用户。</p>\n<p>当查询的条件为：男性用户且年龄为20-30时，则先通过得到男性用户的id，然后得到年龄到20-30之间的用户id，最后通过取两者的交集(Jedis.sinter)就可得到符合这一条件的用户id，进而得到所要数据。</p>\n<p>若是or条件则取并集就行。</p>\n<p>#######小结</p>\n<p>到这，你会发现这些方法都是比较麻烦或无法达到要求的，这是由于这些非关系型数据库本身的设计所决定的，非关系型数据库并不适合各种条件或强关联查询。所以进行强关系条件查询的还是使用关系型数据库进行操作。</p>\n"},{"title":"ubuntu安装mysql环境(离线压缩包方式)","url":"http://yoursite.com/2016/10/31/ubuntu安装mysql环境-离线压缩包方式/","content":"<p>#######1,下载mysql<br>Ubuntu 14.04 安装 64位的 MySQL 5.7.9<br>到官网 <a href=\"http://dev.mysql.com/downloads/mysql/\" target=\"_blank\" rel=\"external\">http://dev.mysql.com/downloads/mysql/</a> 下载<br>Ubuntu Linux 14.04 (x86, 64-bit), DEB Bundle<br>(文件名： mysql-server_5.7.9-1ubuntu14.04_amd64.deb-bundle.tar)</p>\n<p>#######2,放在 /home/soft/ 下解压：</p>\n<pre><code>cd /home/soft/\nsudo chmod +x mysql-server_5.7.9-1ubuntu14.04_amd64.deb-bundle.tar\ntar -zxvf mysql-server_5.7.9-1ubuntu14.04_amd64.deb-bundle.tar\n</code></pre><p>#######3,解压出以下文件：</p>\n<p>libmysqlclient20_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>libmysqlclient-dev_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>libmysqld-dev_5.7.9-1ubuntu14.04_amd64.deb  </p>\n<p>mysql-community-client_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>mysql-community-server_5.7.9-1ubuntu14.04_amd64.deb      </p>\n<p>mysql-community-source_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>mysql-client_5.7.9-1ubuntu14.04_amd64.deb         </p>\n<p>mysql-community-test_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>mysql-common_5.7.9-1ubuntu14.04_amd64.deb         </p>\n<p>mysql-server_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>mysql-community_5.7.9-1ubuntu14.04_amd64.changes  </p>\n<p>mysql-testsuite_5.7.9-1ubuntu14.04_amd64.deb</p>\n<p>#######4,更新设置到最新系统：<br>    sudo apt-get update<br>    sudo apt-get upgrade<br>    apt-get install libaio1</p>\n<p>#######5,然后分别安装以下的包：<br>    sudo dpkg -i mysql-common_5.7.9-1ubuntu14.04_amd64.deb<br>    sudo dpkg-preconfigure mysql-community-server_5.7.9-1ubuntu14.04_amd64.deb<br>此步需要输入数据的root密码</p>\n<pre><code>sudo dpkg -i libmysqlclient20_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i libmysqlclient-dev_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i libmysqld-dev_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i mysql-client_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i mysql-community-client_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i mysql-common_5.7.9-1ubuntu14.04_amd64.deb\n\nsudo apt-get -f install\n</code></pre><p>#######6,此步为了安装依赖包 libmecab2</p>\n<pre><code>sudo dpkg -i mysql-community-server_5.7.9-1ubuntu14.04_amd64.deb\nsudo dpkg -i mysql-server_5.7.9-1ubuntu14.04_amd64.deb\n</code></pre><p>#######7,这时数据安装完成，并自动启动</p>\n<p>#######8,查看mysql安装的路径和依赖：</p>\n<pre><code>whereis mysql\n\nmysql: /usr/bin/mysql /etc/mysql /usr/lib/mysql /usr/include/mysql /usr/share/mysql /usr/share/man/man1/mysql.1.gz\n</code></pre><p>这时你会发现 mysql以服务形式自启动</p>\n<p>######麻烦吗，不麻烦还玩个啥！</p>\n"},{"title":"first commit","url":"http://yoursite.com/2016/10/24/first commit/","content":"<p>committed ,pls wait … 请静候…</p>\n"},{"title":"first commit","url":"http://yoursite.com/first-commit/index.html","content":""},{"title":"category","url":"http://yoursite.com/category/index.html","content":""},{"title":"search","url":"http://yoursite.com/search/index.html","content":""},{"title":"project","url":"http://yoursite.com/project/index.html","content":""},{"title":"tag","url":"http://yoursite.com/tag/index.html","content":""},{"title":"about","url":"http://yoursite.com/about/index.html","content":""},{"title":"link","url":"http://yoursite.com/link/index.html","content":""}]